# 🏗️ Архитектура проекта

## 📊 Схема работы системы

```
┌─────────────────────────────────────────────────────────────────┐
│                    TELEGRAM LEAD PARSER                          │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────┐         ┌──────────────────┐
│   ПОЛЬЗОВАТЕЛЬ   │◄────────┤  АДМИН-ПАНЕЛЬ    │
│                  │  /start │   (bot.py)       │
│  Telegram App    │  /help  │                  │
└──────────────────┘         │  • aiogram 3.x   │
                             │  • Inline меню   │
                             │  • FSM состояния │
                             └────────┬─────────┘
                                      │
                                      │ SQLite
                                      ▼
                             ┌─────────────────┐
                             │   DATABASE      │
                             │  (database.py)  │
                             │                 │
                             │  ┌────────────┐ │
                             │  │ keywords   │ │
                             │  │ stopwords  │ │
                             │  │ blacklist  │ │
                             │  │ config     │ │
                             │  │ logs       │ │
                             │  │ sources    │ │
                             │  └────────────┘ │
                             └────────┬────────┘
                                      │
                                      │ Читает конфиг
                                      ▼
                             ┌─────────────────┐
                             │    ПАРСЕР       │
                             │  (worker.py)    │
                             │                 │
                             │  • Telethon     │
                             │  • User-mode    │
                             │  • Event loop   │
                             └────────┬────────┘
                                      │
                   ┌──────────────────┼──────────────────┐
                   │                  │                  │
                   ▼                  ▼                  ▼
            ┌───────────┐      ┌───────────┐      ┌───────────┐
            │  ГРУППЫ   │      │  КАНАЛЫ   │      │  ДИАЛОГИ  │
            │           │      │           │      │           │
            │  👥       │      │  📢       │      │  💬       │
            └─────┬─────┘      └─────┬─────┘      └─────┬─────┘
                  │                  │                  │
                  └──────────────────┼──────────────────┘
                                     │
                          Новое сообщение
                                     │
                                     ▼
                          ┌─────────────────┐
                          │   ФИЛЬТРАЦИЯ    │
                          │                 │
                          │ 1. От бота?     │
                          │ 2. Ключ-слова?  │
                          │ 3. Стоп-слова?  │
                          │ 4. Черный список?│
                          │ 5. Дубликат?    │
                          └────────┬────────┘
                                   │
                          ✅ Прошел фильтры
                                   │
                                   ▼
                          ┌─────────────────┐
                          │   УВЕДОМЛЕНИЕ   │
                          │                 │
                          │ 🔥 Новый лид    │
                          │ • Информация    │
                          │ • Пересылка     │
                          └────────┬────────┘
                                   │
                                   ▼
                          ┌─────────────────┐
                          │   ЧАТ ЛИДОВ     │
                          │                 │
                          │  📩 Сообщение   │
                          └─────────────────┘
```

## 🔄 Жизненный цикл сообщения

```
1. [СООБЩЕНИЕ] Пользователь пишет в группу/канал
                        ↓
2. [TELETHON] Worker получает событие NewMessage
                        ↓
3. [ПРОВЕРКА] should_process_message()
   • Парсер включен?
   • Не от бота?
   • Тип чата разрешен?
                        ↓
4. [ФИЛЬТР] filter_message()
   • Есть ключевые слова?
   • Нет стоп-слов?
   • Не в черном списке?
   • Не дубликат?
                        ↓
5. [УВЕДОМЛЕНИЕ] send_lead_notification()
   • Отправка информации
   • Пересылка сообщения
                        ↓
6. [ЛОГИРОВАНИЕ] add_log()
   • Сохранение в БД
```

## 📦 Модульная структура

### 🤖 bot.py - Админ-панель

**Ответственность:**
- Интерфейс управления
- Навигация по меню
- Управление настройками
- FSM для ввода данных

**Основные компоненты:**
- `Router` - маршрутизация команд
- `Form` - FSM состояния
- Keyboard builders - клавиатуры
- Handlers - обработчики callback'ов

**Зависимости:**
- `aiogram` - Telegram Bot API
- `database.py` - работа с данными
- `config.py` - конфигурация

---

### 🔍 worker.py - Парсер

**Ответственность:**
- Слушание сообщений
- Фильтрация по правилам
- Отправка уведомлений

**Основные компоненты:**
- `MessageFilter` - логика фильтрации
- `TelegramParser` - основной класс парсера
- Event handlers - обработчики событий

**Зависимости:**
- `telethon` - Telegram Client API
- `database.py` - работа с данными
- `config.py` - конфигурация

---

### 🗄️ database.py - База данных

**Ответственность:**
- CRUD операции
- Управление таблицами
- Транзакции

**Основные компоненты:**
- `Database` - главный класс
- Методы для каждой таблицы
- Вспомогательные функции

**Таблицы:**
```sql
keywords     -- Ключевые слова
stopwords    -- Стоп-слова
blacklist    -- Черный список
config       -- Конфигурация
logs         -- История лидов
sources      -- Источники (будущее)
```

---

### ⚙️ config.py - Конфигурация

**Ответственность:**
- Загрузка .env
- Предоставление констант

**Переменные:**
- `BOT_TOKEN` - токен бота
- `API_ID` / `API_HASH` - API Telegram
- `SESSION_STRING` - сессия Telethon
- `ADMIN_IDS` - администраторы
- `DATABASE_PATH` - путь к БД

---

### 🚀 run.py - Оркестратор

**Ответственность:**
- Запуск обоих процессов
- Обработка сигналов
- Управление жизненным циклом

**Процессы:**
- `Process 1` - bot.py (админ-панель)
- `Process 2` - worker.py (парсер)

---

### 📤 outbox.py - Исходящие (будущее)

**Ответственность:**
- Рассылка по лидам
- Шаблоны сообщений
- Очередь отправки

**Статус:** 🚧 В разработке

---

## 🔐 Безопасность

### Уровни защиты

```
┌─────────────────────────────────────┐
│  1. .gitignore                      │  ← .env не попадает в Git
│  2. .env file                       │  ← Токены в переменных окружения
│  3. Session files                   │  ← Сессии Telegram
│  4. Separate tech account           │  ← Отдельный технический аккаунт
│  5. Admin IDs check                 │  ← Проверка прав доступа
└─────────────────────────────────────┘
```

### Угрозы и защита

| Угроза | Защита |
|--------|--------|
| Утечка токенов | `.env` в `.gitignore` |
| Компрометация аккаунта | Отдельный технический аккаунт |
| Блокировка Telegram | Умеренный парсинг, без спама |
| SQL Injection | Параметризованные запросы |
| Доступ посторонних | ADMIN_IDS проверка |

---

## 📊 Потоки данных

### Конфигурация (Config Flow)

```
.env → config.py → bot.py/worker.py
                 → database.py
```

### Данные пользователя (User Data Flow)

```
Пользователь → Админ-панель → Database → Парсер
```

### Лиды (Leads Flow)

```
Telegram → Worker → Filter → Notification → User
                   → Database (logs)
```

---

## 🧩 Паттерны проектирования

### 1. Repository Pattern
`database.py` абстрагирует работу с БД

### 2. Strategy Pattern
`MessageFilter` - разные стратегии фильтрации

### 3. Observer Pattern
Telethon Events - реакция на новые сообщения

### 4. Singleton Pattern
`Database` - один экземпляр на приложение

### 5. FSM Pattern
aiogram FSM - управление состояниями бота

---

## 🔧 Расширяемость

### Как добавить новую функцию?

#### 1. Новая таблица в БД

```python
# database.py
def init_db(self):
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS new_table (
            id INTEGER PRIMARY KEY,
            ...
        )
    """)
```

#### 2. Новый обработчик в боте

```python
# bot.py
@router.callback_query(F.data == "new_feature")
async def new_feature_handler(callback: CallbackQuery):
    # Ваш код
    pass
```

#### 3. Новый фильтр в парсере

```python
# worker.py
class MessageFilter:
    @staticmethod
    def check_new_rule(text: str) -> bool:
        # Ваша логика
        pass
```

---

## 📈 Масштабирование

### Горизонтальное

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│ Worker 1 │     │ Worker 2 │     │ Worker 3 │
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     └────────────────┼────────────────┘
                      │
              ┌───────▼────────┐
              │   Database     │
              └────────────────┘
```

### Вертикальное

```
SQLite → PostgreSQL (для больших объемов)
Local → VPS → Dedicated Server
```

---

## 🎯 Производительность

### Узкие места

1. **SQLite** - ограничение на concurrent writes
2. **Single process** - один парсер на аккаунт
3. **Rate limits** - ограничения Telegram API

### Оптимизации

1. **Batch operations** - групповые операции с БД
2. **Caching** - кеширование настроек
3. **Async/await** - асинхронная обработка
4. **Connection pooling** - пул подключений

---

**Подробнее о каждом компоненте смотрите в исходном коде!**

